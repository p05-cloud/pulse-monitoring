# Render.com Blueprint for PULSE Monitoring Platform
# This file defines all infrastructure: API, Database, Redis

services:
  # ==============================================
  # PULSE API - Main Application
  # ==============================================
  - type: web
    name: pulse-api
    runtime: docker
    dockerfilePath: ./apps/api/Dockerfile
    dockerContext: .
    region: oregon  # Change to your preferred region
    plan: free  # Free tier (750 hours/month)

    # Environment variables (set these in Render dashboard)
    envVars:
      - key: NODE_ENV
        value: production

      - key: PORT
        value: 3001

      # Database (auto-populated from postgres service)
      - key: DATABASE_URL
        fromDatabase:
          name: pulse-postgres
          property: connectionString

      # Redis (auto-populated from redis service)
      - key: REDIS_HOST
        fromService:
          type: redis
          name: pulse-redis
          property: host

      - key: REDIS_PORT
        fromService:
          type: redis
          name: pulse-redis
          property: port

      # IMPORTANT: Set these in Render Dashboard
      - key: JWT_SECRET
        generateValue: true  # Auto-generate secure value

      - key: JWT_REFRESH_SECRET
        generateValue: true  # Auto-generate secure value

      - key: JWT_EXPIRES_IN
        value: 7d

      - key: JWT_REFRESH_EXPIRES_IN
        value: 30d

      # Resend Email (YOU MUST SET THIS MANUALLY)
      - key: RESEND_API_KEY
        sync: false  # Set manually in dashboard

      - key: EMAIL_FROM
        value: PULSE Monitoring <onboarding@resend.dev>

      # Frontend URL (update after deployment)
      - key: FRONTEND_URL
        value: http://localhost:3000

      # Rate limiting
      - key: RATE_LIMIT_WINDOW_MS
        value: 900000

      - key: RATE_LIMIT_MAX_REQUESTS
        value: 100

      - key: LOG_LEVEL
        value: info

    # Build command
    buildCommand: |
      echo "Building PULSE API..."
      npm ci
      cd apps/api
      npx prisma generate
      npm run build

    # Start command
    startCommand: |
      cd apps/api
      npx prisma migrate deploy
      psql $DATABASE_URL -f scripts/add-indexes.sql || true
      node dist/index.js

    # Health check
    healthCheckPath: /health

    # Auto-deploy on git push
    autoDeploy: true

  # ==============================================
  # Redis Cache & Queue
  # ==============================================
  - type: redis
    name: pulse-redis
    plan: free  # 25MB free
    region: oregon  # Same region as API
    maxmemoryPolicy: allkeys-lru  # Evict least recently used keys
    ipAllowList: []  # Empty = allow from anywhere

# ==============================================
# PostgreSQL Database
# ==============================================
databases:
  - name: pulse-postgres
    databaseName: pulse
    plan: free  # Free for 90 days, then $7/month
    region: oregon  # Same region as API
    # ipAllowList: []  # Empty = allow from anywhere
