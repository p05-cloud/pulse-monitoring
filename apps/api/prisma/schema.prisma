// Pulse Monitoring Platform - Database Schema
// Generated from CLAUDE.md specification

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String?
  role          UserRole  @default(VIEWER)
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Two-Factor Authentication
  twoFactorSecret   String?   @map("two_factor_secret")
  twoFactorEnabled  Boolean   @default(false) @map("two_factor_enabled")
  backupCodes       String[]  @default([]) @map("backup_codes")

  // Relations
  activityLogs      ActivityLog[]
  projectUsers      ProjectUser[]
  sentInvitations   TeamInvitation[] @relation("Inviter")

  @@map("users")
}

// ============================================
// TEAM INVITATIONS
// ============================================

model TeamInvitation {
  id          String    @id @default(uuid())
  email       String
  role        UserRole  @default(VIEWER)
  token       String    @unique
  invitedById String    @map("invited_by_id")
  expiresAt   DateTime  @map("expires_at")
  acceptedAt  DateTime? @map("accepted_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  invitedBy   User      @relation("Inviter", fields: [invitedById], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@map("team_invitations")
}

enum UserRole {
  ADMIN      // Full access - manage team, billing, all settings
  DEVELOPER  // Manage monitors, alert contacts, view reports
  VIEWER     // Read-only access to dashboards and reports
  USER       // Legacy - treated as DEVELOPER for backward compatibility
}

// ============================================
// PROJECTS & ORGANIZATION
// ============================================

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  color       String   @default("#3B82F6") // For UI badges
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  monitors     Monitor[]
  projectUsers ProjectUser[]
  slaConfig    SLAConfig?

  @@map("projects")
}

// ============================================
// SLA CONFIGURATION
// ============================================

model SLAConfig {
  id                String   @id @default(uuid())
  projectId         String   @unique @map("project_id")
  targetUptime      Float    @default(99.9) @map("target_uptime") // 99.9%, 99.95%, 99.99%
  maxResponseTimeMs Int      @default(5000) @map("max_response_time_ms")
  alertOnBreach     Boolean  @default(true) @map("alert_on_breach")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("sla_configs")
}

model ProjectUser {
  projectId String  @map("project_id")
  userId    String  @map("user_id")
  role      String  @default("member") // owner, member

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([projectId, userId])
  @@map("project_users")
}

// ============================================
// MONITORS
// ============================================

model Monitor {
  id                  String        @id @default(uuid())
  projectId           String        @map("project_id")
  name                String
  url                 String
  method              HttpMethod    @default(GET)
  intervalSeconds     Int           @default(60) @map("interval_seconds")
  timeoutMs           Int           @default(30000) @map("timeout_ms")
  expectedStatus      Int           @default(200) @map("expected_status")
  keyword             String?
  headers             Json          @default("{}")
  body                String?       // Request body for POST/PUT/PATCH/DELETE
  tags                String[]      @default([])

  // Aggregator support
  monitorType         MonitorType   @default(SIMPLE) @map("monitor_type")
  aggregatorConfig    Json?         @map("aggregator_config") // { arrayPath, nameField, statusField, etc. }

  // Status
  isActive            Boolean       @default(true) @map("is_active")
  currentStatus       MonitorStatus @default(UNKNOWN) @map("current_status")
  lastCheckAt         DateTime?     @map("last_check_at")
  lastStatusChangeAt  DateTime?     @map("last_status_change_at")
  consecutiveFailures Int           @default(0) @map("consecutive_failures")

  // Metadata
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  // SSL/Domain Monitoring
  sslExpiresAt        DateTime? @map("ssl_expires_at")
  domainExpiresAt     DateTime? @map("domain_expires_at")
  lastSslCheck        DateTime? @map("last_ssl_check")

  // Relations
  project             Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  checkResults        CheckResult[]
  incidents           Incident[]
  alertContacts       MonitorAlertContact[]
  escalationPolicy    MonitorEscalation?

  @@index([projectId])
  @@index([currentStatus])
  @@index([monitorType])
  @@index([tags])
  @@map("monitors")
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
  HEAD
  OPTIONS
}

enum MonitorType {
  SIMPLE      // Standard single-endpoint monitor
  AGGREGATOR  // Parses response array and creates sub-monitors
}

enum MonitorStatus {
  UP
  DOWN
  DEGRADED
  UNKNOWN
  PAUSED
}

// ============================================
// CHECK RESULTS
// ============================================

model CheckResult {
  id             String    @id @default(uuid())
  monitorId      String    @map("monitor_id")
  checkedAt      DateTime  @map("checked_at")
  success        Boolean
  responseTimeMs Int?      @map("response_time_ms")
  statusCode     Int?      @map("status_code")
  errorCategory  String?   @map("error_category")
  errorMessage   String?   @map("error_message")
  rcaDetails     Json?     @map("rca_details")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Aggregator support - for sub-monitor checks
  subMonitorName String?   @map("sub_monitor_name") // e.g., "Admin Service", "Auth Service"
  subMonitorData Json?     @map("sub_monitor_data") // Full sub-monitor object from response

  // Relations
  monitor Monitor @relation(fields: [monitorId], references: [id], onDelete: Cascade)

  @@index([monitorId, checkedAt(sort: Desc)])
  @@index([monitorId, subMonitorName])
  @@map("check_results")
}

// ============================================
// INCIDENTS
// ============================================

model Incident {
  id              String         @id @default(uuid())
  monitorId       String         @map("monitor_id")
  status          IncidentStatus @default(OPEN)
  startedAt       DateTime       @map("started_at")
  acknowledgedAt  DateTime?      @map("acknowledged_at")
  acknowledgedBy  String?        @map("acknowledged_by")
  resolvedAt      DateTime?      @map("resolved_at")
  durationSeconds Int?           @map("duration_seconds")
  errorCategory   String?        @map("error_category")
  errorMessage    String?        @map("error_message")
  rcaDetails      Json?          @map("rca_details")
  notes           String?
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  monitor           Monitor            @relation(fields: [monitorId], references: [id], onDelete: Cascade)
  notificationLogs  NotificationLog[]

  @@index([monitorId, status])
  @@index([startedAt(sort: Desc)])
  @@map("incidents")
}

enum IncidentStatus {
  OPEN
  ACKNOWLEDGED
  RESOLVED
}

// ============================================
// ALERT CONTACTS & NOTIFICATIONS
// ============================================

model AlertContact {
  id        String           @id @default(uuid())
  name      String
  type      AlertContactType
  config    Json             // { email: "...", webhookUrl: "...", teamsWebhook: "..." }
  isActive  Boolean          @default(true) @map("is_active")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  // Relations
  monitors         MonitorAlertContact[]
  notificationLogs NotificationLog[]

  @@map("alert_contacts")
}

enum AlertContactType {
  EMAIL
  TEAMS
  WEBHOOK
  SLACK
}

model MonitorAlertContact {
  monitorId      String @map("monitor_id")
  alertContactId String @map("alert_contact_id")

  monitor      Monitor      @relation(fields: [monitorId], references: [id], onDelete: Cascade)
  alertContact AlertContact @relation(fields: [alertContactId], references: [id], onDelete: Cascade)

  @@id([monitorId, alertContactId])
  @@map("monitor_alert_contacts")
}

model NotificationLog {
  id             String             @id @default(uuid())
  incidentId     String             @map("incident_id")
  alertContactId String             @map("alert_contact_id")
  type           NotificationType
  status         NotificationStatus @default(PENDING)
  sentAt         DateTime?          @map("sent_at")
  errorMessage   String?            @map("error_message")
  retryCount     Int                @default(0) @map("retry_count")
  createdAt      DateTime           @default(now()) @map("created_at")

  // Relations
  incident     Incident     @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  alertContact AlertContact @relation(fields: [alertContactId], references: [id], onDelete: Cascade)

  @@map("notification_logs")
}

enum NotificationType {
  DOWN
  UP
  DEGRADED
  ACKNOWLEDGED
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

// ============================================
// REPORTS
// ============================================

model ReportSchedule {
  id          String          @id @default(uuid())
  name        String
  frequency   ReportFrequency
  projectIds  String[]        @map("project_ids")
  recipients  String[]        // Email addresses
  format      ReportFormat    @default(PDF)
  isActive    Boolean         @default(true) @map("is_active")
  lastRunAt   DateTime?       @map("last_run_at")
  nextRunAt   DateTime?       @map("next_run_at")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  @@map("report_schedules")
}

enum ReportFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

enum ReportFormat {
  PDF
  EXCEL
  CSV
}

model GeneratedReport {
  id          String       @id @default(uuid())
  scheduleId  String?      @map("schedule_id")
  name        String
  format      ReportFormat
  startDate   DateTime     @map("start_date")
  endDate     DateTime     @map("end_date")
  filePath    String?      @map("file_path")
  fileSize    Int?         @map("file_size")
  status      String       @default("PENDING") // PENDING, GENERATING, COMPLETED, FAILED
  createdAt   DateTime     @default(now()) @map("created_at")

  @@map("generated_reports")
}

// ============================================
// ACTIVITY LOGS
// ============================================

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([createdAt(sort: Desc)])
  @@map("activity_logs")
}

// ============================================
// MAINTENANCE WINDOWS
// ============================================

model MaintenanceWindow {
  id          String   @id @default(uuid())
  name        String
  description String?
  monitorIds  String[] @map("monitor_ids")
  startTime   DateTime @map("start_time")
  endTime     DateTime @map("end_time")
  timezone    String   @default("UTC")
  recurring   Boolean  @default(false)
  cronPattern String?  @map("cron_pattern") // For recurring windows
  notifyBefore Int     @default(30) @map("notify_before") // Minutes before to notify
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([startTime])
  @@index([endTime])
  @@map("maintenance_windows")
}

// ============================================
// ESCALATION POLICIES
// ============================================

model EscalationPolicy {
  id          String    @id @default(uuid())
  name        String
  description String?
  // Levels stored as JSON: [{ delayMinutes: 5, contactIds: [...], notifyAll: true }, ...]
  levels      Json      @default("[]")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  monitors    MonitorEscalation[]

  @@map("escalation_policies")
}

model MonitorEscalation {
  monitorId   String  @unique @map("monitor_id")
  policyId    String  @map("policy_id")

  // Relations
  monitor     Monitor           @relation(fields: [monitorId], references: [id], onDelete: Cascade)
  policy      EscalationPolicy  @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@id([monitorId, policyId])
  @@map("monitor_escalations")
}

// ============================================
// INTEGRATIONS (Slack, Teams, etc.)
// ============================================

model Integration {
  id          String          @id @default(uuid())
  name        String
  type        IntegrationType
  config      Json            // { webhookUrl, channel, token, etc. }
  isActive    Boolean         @default(true) @map("is_active")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  @@map("integrations")
}

enum IntegrationType {
  SLACK
  TEAMS
  DISCORD
  PAGERDUTY
  OPSGENIE
  WEBHOOK
}
